<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Sistem Payroll Enterprise</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

<style>
:root{
    --bg: #0b1220;
    --bg2: #111827;
    --text: #e5e7eb;
    --muted: #9ca3af;
    --card: rgba(255,255,255,0.06);
    --line: rgba(255,255,255,0.1);
    --accent: #2563eb;
}
[data-theme="light"]{
    --bg: #f6f7fb;
    --bg2: #ffffff;
    --text: #111827;
    --muted: #6b7280;
    --card: #ffffff;
    --line: #d1d5db;
    --accent: #1d4ed8;
}
body{
    margin:0;
    background:var(--bg);
    font-family: "Inter", sans-serif;
    color:var(--text);
}

/* ===== LOGIN PAGE (simple, still same theme) ===== */
.login-wrap{
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
}
.login-box{
    width:100%;
    max-width:380px;
    background:var(--bg2);
    border:1px solid var(--line);
    border-radius:14px;
    padding:18px;
}
.login-box h2{margin-top:0}
.login-box .small{color:var(--muted);font-size:13px}

/* topbar */
.topbar{
    height:58px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 15px;
    background:var(--bg2);
    border-bottom:1px solid var(--line);
    position:fixed;
    left:0; right:0;
    z-index:10;
}
.top-action-btn{
    border:1px solid var(--line);
    padding:6px 10px;
    border-radius:6px;
    background:transparent;
    color:var(--text);
    cursor:pointer;
}

/* sidebar */
.sidebar{
    width:240px;
    position:fixed;
    top:58px;
    bottom:0;
    left:0;
    padding:10px;
    background:var(--bg2);
    border-right:1px solid var(--line);
    transition:.3s;
}
.sidebar.collapsed{ width:70px; }
.sidebar .menu-btn{
    width:100%;
    padding:10px;
    border:none;
    border-radius:8px;
    background:transparent;
    color:var(--text);
    text-align:left;
    display:flex;
    gap:10px;
    align-items:center;
    margin-bottom:6px;
    cursor:pointer;
}
.sidebar .menu-btn:hover,
.sidebar .menu-btn.active{
    background:var(--card);
}
.sidebar.collapsed .menu-btn span{
    display:none;
}

.content{
    margin-left:240px;
    padding:75px 15px 20px;
    transition:.3s;
}
.sidebar.collapsed ~ .content{
    margin-left:70px;
}

/* cards */
.card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:10px;
    padding:15px;
    margin-bottom:15px;
}

/* grid */
.grid{
    display:grid;
    gap:10px;
}
.grid-2{ grid-template-columns:repeat(2,1fr); }
.grid-3{ grid-template-columns:repeat(3,1fr); }

/* responsive */
@media(max-width:800px){
    .grid-3{ grid-template-columns:1fr; }
    .grid-2{ grid-template-columns:1fr; }
}

/* table */
table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    border:1px solid var(--line);
    background:var(--card);
    border-radius:10px;
    overflow:hidden;
}
table th{
    background:var(--bg2);
    padding:10px;
    border-bottom:1px solid var(--line);
    text-align:left;
}
table td{
    padding:10px;
    border-bottom:1px solid var(--line);
}

/* form */
input,select{
    width:100%;
    padding:10px;
    background:transparent;
    border:1px solid var(--line);
    border-radius:8px;
    color:var(--text);
}
select option{
    background:var(--bg2);
    color:var(--text);
}

/* buttons */
.btn{
    padding:9px 14px;
    border:none;
    border-radius:8px;
    cursor:pointer;
}
.btn-primary{ background:var(--accent); color:white; }
.btn-danger{ background:#dc2626; color:white; }
.btn-soft{
    background:var(--bg2);
    border:1px solid var(--line);
    color:var(--text);
}

/* modal */
.modal-bg{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.5);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:20;
}
.modal-box{
    background:var(--bg2);
    width:95%;
    max-width:500px;
    padding:15px;
    border-radius:10px;
    border:1px solid var(--line);
}

/* slip */
.slip{
    background:white;
    color:#111827;
    border-radius:10px;
    padding:15px;
    line-height:1.5;
}
.slip .row{
    display:flex;
    justify-content:space-between;
}
</style>
</head>

<body data-theme="dark">

<!-- ==========================
     LOGIN PAGE 
=========================== -->
<div id="loginPage" class="login-wrap">
  <div class="login-box">
    <h2>Login</h2>
    <div class="small">Admin / HRD masuk pakai akun default</div>
    <br>
    <label>Username</label>
    <input id="lgUser" placeholder="admin">
    <label>Password</label>
    <input id="lgPass" type="password" placeholder="admin123">
    <button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="doLogin()">Login</button>
    <p class="small" style="margin-top:10px">
      Default akun: <b>admin / admin123</b>
    </p>
  </div>
</div>


<!-- ==========================
     MAIN APP 
=========================== -->
<div id="appPage" style="display:none;">

  <!-- TOP BAR -->
  <div class="topbar">
      <div style="display:flex;align-items:center;gap:6px;">
          <i class="bi bi-building" style="color:var(--accent);font-size:20px;"></i>
          <b>Sistem Payroll Enterprise</b>
      </div>

      <div style="display:flex;gap:6px;align-items:center;">
          <span id="whoLogin" style="color:var(--muted);font-size:13px;"></span>
          <button class="top-action-btn" onclick="toggleSidebar()"><i class="bi bi-layout-sidebar"></i></button>
          <button class="top-action-btn" onclick="switchTheme()"><i class="bi bi-moon-stars"></i></button>
          <button class="top-action-btn" onclick="doLogout()"><i class="bi bi-box-arrow-right"></i></button>
      </div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar" id="sideMenu">
      <button class="menu-btn active" data-pg="dash" onclick="openPage('dash')">
          <i class="bi bi-speedometer2"></i><span>Dashboard</span>
      </button>
      <button class="menu-btn" data-pg="emp" onclick="openPage('emp')">
          <i class="bi bi-people"></i><span>Data Karyawan</span>
      </button>
      <button class="menu-btn" data-pg="grade" onclick="openPage('grade')">
          <i class="bi bi-person-badge"></i><span>Data Jabatan</span>
      </button>
      <button class="menu-btn" data-pg="att" onclick="openPage('att')">
          <i class="bi bi-calendar-check"></i><span>Absensi</span>
      </button>
      <button class="menu-btn" data-pg="pay" onclick="openPage('pay')">
          <i class="bi bi-cash-stack"></i><span>Penggajian</span>
      </button>
      <button class="menu-btn" data-pg="slip" onclick="openPage('slip')">
          <i class="bi bi-receipt-cutoff"></i><span>Slip Gaji</span>
      </button>
      <button class="menu-btn" data-pg="rep" onclick="openPage('rep')">
          <i class="bi bi-file-text"></i><span>Laporan</span>
      </button>
  </div>

  <!-- CONTENT -->
  <div class="content">

      <!-- DASHBOARD 
      <div id="page_dash" class="page-box">
          <h2>Dashboard</h2>
          <div class="grid grid-3">
              <div class="card">
                  <div style="color:var(--muted)">Total Karyawan</div>
                  <h1 id="statEmp">0</h1>
              </div>
              <div class="card">
                  <div style="color:var(--muted)">Total Jabatan/Grade</div>
                  <h1 id="statGrade">0</h1>
              </div>
              <div class="card">
                  <div style="color:var(--muted)">Slip Gaji Bulan Ini</div>
                  <h1 id="statSlip">0</h1>
              </div>
          </div>
      </div>

      <!-- DATA KARYAWAN -->
      <div id="page_emp" class="page-box" style="display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
              <h2>Data Karyawan</h2>
              <button class="btn-primary" onclick="openEmpModal()">+ Karyawan</button>
          </div>
          <table>
              <thead>
                  <tr>
                      <th>NIP</th><th>Nama</th><th>Dept</th><th>Posisi</th><th>Jabatan</th><th>Aksi</th>
                  </tr>
              </thead>
              <tbody id="empList"></tbody>
          </table>
      </div>

      <!-- DATA JABATAN / GRADE -->
      <div id="page_grade" class="page-box" style="display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
              <h2>Data Jabatan</h2>
              <button class="btn-primary" onclick="openGradeModal()">+ Jabatan</button>
          </div>
          <table>
              <thead>
                  <tr>
                      <th>Jabatan/Grade</th><th>Gaji Pokok</th><th>Tunj. Jabatan</th><th>Rate Lembur/Jam</th><th>Aksi</th>
                  </tr>
              </thead>
              <tbody id="gradeList"></tbody>
          </table>
      </div>

      <!-- ABSENSI  -->
      <div id="page_att" class="page-box" style="display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
              <h2>Absensi</h2>
              <button class="btn-primary" onclick="openAttModal()">+ Absensi</button>
          </div>
          <table>
              <thead>
                  <tr>
                      <th>Tanggal</th><th>Karyawan</th><th>Status</th><th>Telat (menit)</th><th>Lembur (jam)</th><th>Aksi</th>
                  </tr>
              </thead>
              <tbody id="attList"></tbody>
          </table>
      </div>

      <!-- PENGGAJIAN  -->
      <div id="page_pay" class="page-box" style="display:none;">
          <h2>Penggajian (Hitung Otomatis)</h2>

          <div class="card grid grid-2">
              <div>
                  <label>Pilih Karyawan</label>
                  <select id="payEmpSelect"></select>
              </div>
              <div>
                  <label>Bulan</label>
                  <input type="month" id="payMonth">
              </div>
              <div>
                  <label>Tunj. Transport</label>
                  <input id="payTransport" type="number" value="300000">
              </div>
              <div>
                  <label>Tunj. Makan</label>
                  <input id="payMeal" type="number" value="400000">
              </div>
              <div>
                  <label>Tunj. Kehadiran</label>
                  <input id="payAtt" type="number" value="250000">
              </div>
              <div>
                  <label>Tunjangan Lain</label>
                  <input id="payOtherAllow" type="number" value="0">
              </div>
              <div>
                  <label>Potongan Lain</label>
                  <input id="payOtherDed" type="number" value="0">
              </div>

              <div style="display:flex;align-items:flex-end;">
                  <button class="btn-primary" onclick="runPayroll()">Hitung Gaji</button>
              </div>
          </div>

          <div class="card" id="payPreviewCard" style="display:none;">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <h3>Preview Slip (sementara)</h3>
                <div style="display:flex;gap:6px;">
                  <button class="btn-soft" onclick="saveSlip()">Simpan Slip</button>
                  <button class="btn-primary" onclick="exportSlip()">Export PDF</button>
                </div>
              </div>
              <div id="slipBox" class="slip"></div>
          </div>
      </div>

      <!-- SLIP GAJI -->
      <div id="page_slip" class="page-box" style="display:none;">
          <h2>Slip Gaji</h2>
          <div class="card">
            <label>Pilih slip untuk dilihat / cetak</label>
            <select id="slipSelect" onchange="viewSlipFromList()"></select>
          </div>
          <div class="card" id="slipViewCard" style="display:none;">
            <div style="display:flex;justify-content:space-between;">
              <h3>Detail Slip</h3>
              <button class="btn-primary" onclick="exportSlip()">Export PDF</button>
            </div>
            <div id="slipViewBox" class="slip"></div>
          </div>
      </div>

      <!-- LAPORAN  -->
      <div id="page_rep" class="page-box" style="display:none;">
          <h2>Laporan Penggajian</h2>
          <table>
              <thead>
                  <tr>
                      <th>Bulan</th><th>Karyawan</th><th>Gross</th><th>Potongan</th><th>Take Home</th>
                  </tr>
              </thead>
              <tbody id="repList"></tbody>
          </table>
      </div>

  </div>
</div>


<!-- ========= MODAL KARYAWAN ========= -->
<div class="modal-bg" id="empModal">
    <div class="modal-box">
        <h3 id="empModalTitle">Tambah Karyawan</h3>
        <label>NIP</label><input id="empNip">
        <label>Nama</label><input id="empName">
        <label>Departemen</label><input id="empDept">
        <label>Posisi</label><input id="empPos">
        <label>Jabatan/Grade</label><select id="empGrade"></select>
        <div style="display:flex;justify-content:flex-end;margin-top:10px;gap:6px;">
            <button class="btn-soft" onclick="closeEmpModal()">Batal</button>
            <button class="btn-primary" onclick="saveEmp()">Simpan</button>
        </div>
    </div>
</div>

<!-- ========= MODAL JABATAN/GRADE ========= -->
<div class="modal-bg" id="gradeModal">
    <div class="modal-box">
        <h3 id="gradeModalTitle">Tambah Jabatan</h3>
        <label>Nama Jabatan/Grade</label><input id="grName">
        <label>Gaji Pokok</label><input id="grBasic" type="number">
        <label>Tunj. Jabatan</label><input id="grPosAllow" type="number">
        <label>Rate Lembur / Jam</label><input id="grOt" type="number">

        <div style="display:flex;justify-content:flex-end;margin-top:10px;gap:6px;">
            <button class="btn-soft" onclick="closeGradeModal()">Batal</button>
            <button class="btn-primary" onclick="saveGrade()">Simpan</button>
        </div>
    </div>
</div>

<!-- ========= MODAL ABSENSI ========= -->
<div class="modal-bg" id="attModal">
    <div class="modal-box">
        <h3>Input Absensi</h3>
        <label>Tanggal</label><input id="attDate" type="date">
        <label>Karyawan</label><select id="attEmp"></select>
        <label>Status</label>
        <select id="attStatus">
            <option value="hadir">Hadir</option>
            <option value="izin">Izin</option>
            <option value="sakit">Sakit</option>
            <option value="alpa">Alpa</option>
        </select>
        <label>Keterlambatan (menit)</label><input id="attLate" type="number" value="0">
        <label>Lembur (jam)</label><input id="attOt" type="number" value="0">
        <div style="display:flex;justify-content:flex-end;margin-top:10px;gap:6px;">
            <button class="btn-soft" onclick="closeAttModal()">Batal</button>
            <button class="btn-primary" onclick="saveAtt()">Simpan</button>
        </div>
    </div>
</div>


<script>
// ===============================
// LOGIN LOGIC 
// ===============================
const defaultUser = { user:"admin", pass:"admin123", role:"admin" };

function doLogin(){
  const u = lgUser.value.trim();
  const p = lgPass.value.trim();

  if(u === defaultUser.user && p === defaultUser.pass){
    sessionStorage.setItem("isLogin","1");
    sessionStorage.setItem("loginUser", u);
    loginPage.style.display="none";
    appPage.style.display="block";
    whoLogin.textContent = `${u} (${defaultUser.role})`;
    renderAll();
  }else{
    alert("Username / password salah");
  }
}

function doLogout(){
  if(!confirm("Logout sekarang?")) return;
  sessionStorage.removeItem("isLogin");
  sessionStorage.removeItem("loginUser");
  appPage.style.display="none";
  loginPage.style.display="flex";
}

// auto check login
(function(){
  if(sessionStorage.getItem("isLogin")==="1"){
    loginPage.style.display="none";
    appPage.style.display="block";
    whoLogin.textContent = sessionStorage.getItem("loginUser") || "admin";
  }
})();


// ===============================
// DATA STORAGE
// ===============================
let dataEmp   = JSON.parse(localStorage.getItem("empData")   || "[]");
let dataGrade = JSON.parse(localStorage.getItem("gradeData") || "[]");
let dataAtt   = JSON.parse(localStorage.getItem("attData")   || "[]");
let dataSlip  = JSON.parse(localStorage.getItem("slipData")  || "[]");

// default jabatan kalau kosong
if(dataGrade.length === 0){
    dataGrade = [
        {name:"G1", basic:6000000, pos:1500000, ot:40000},
        {name:"G2", basic:4500000, pos:1000000, ot:30000},
        {name:"G3", basic:3500000, pos:700000,  ot:25000}
    ];
}

function saveAll(){
    localStorage.setItem("empData", JSON.stringify(dataEmp));
    localStorage.setItem("gradeData", JSON.stringify(dataGrade));
    localStorage.setItem("attData", JSON.stringify(dataAtt));
    localStorage.setItem("slipData", JSON.stringify(dataSlip));
}

// ===============================
// UI BASIC
// ===============================
function toggleSidebar(){
    document.getElementById("sideMenu").classList.toggle("collapsed");
}
function switchTheme(){
    let th = document.body.getAttribute("data-theme");
    document.body.setAttribute("data-theme", th === "light" ? "dark" : "light");
}

// ===============================
// PAGE NAV
// ===============================
function openPage(pg){
    document.querySelectorAll(".menu-btn").forEach(btn=>{
        btn.classList.remove("active");
        if(btn.getAttribute("data-pg") === pg) btn.classList.add("active");
    });
    document.querySelectorAll(".page-box").forEach(p=>p.style.display="none");
    document.getElementById("page_"+pg).style.display="block";
    renderAll();
}

// ===============================
// UTIL
// ===============================
function rupiah(x){ return "Rp"+(x||0).toLocaleString("id-ID"); }

// ===============================
// RENDER ALL (Dashboard, menus)
// ===============================
function renderAll(){
    renderDashboard();
    renderGrade();
    renderEmp();
    renderAbsensi();
    renderReports();
    fillPayrollSelect();
    fillSlipSelect();
}

function renderDashboard(){
    statEmp.textContent = dataEmp.length;
    statGrade.textContent = dataGrade.length;

    let month = new Date().toISOString().slice(0,7);
    let cnt = dataSlip.filter(s=>s.month===month).length;
    statSlip.textContent = cnt;
}

// render jabatan
function renderGrade(){
    gradeList.innerHTML = "";
    dataGrade.forEach((g,i)=>{
        gradeList.innerHTML += `
            <tr>
                <td>${g.name}</td>
                <td>${rupiah(g.basic)}</td>
                <td>${rupiah(g.pos)}</td>
                <td>${rupiah(g.ot)}</td>
                <td>
                    <button class="btn-soft" onclick="editGrade(${i})">Edit</button>
                    <button class="btn-danger" onclick="delGrade(${i})">Hapus</button>
                </td>
            </tr>
        `;
    });

    // select jabatan di modal karyawan
    empGrade.innerHTML = "";
    dataGrade.forEach(g=>{
        empGrade.innerHTML += `<option value="${g.name}">${g.name}</option>`;
    });
}

// render karyawan
function renderEmp(){
    empList.innerHTML = "";
    dataEmp.forEach((e,i)=>{
        empList.innerHTML += `
        <tr>
            <td>${e.nip}</td>
            <td>${e.nama}</td>
            <td>${e.dept}</td>
            <td>${e.pos}</td>
            <td>${e.grade}</td>
            <td>
                <button class="btn-soft" onclick="editEmp(${i})">Edit</button>
                <button class="btn-danger" onclick="delEmp(${i})">Del</button>
            </td>
        </tr>
        `;
    });
}

// render absensi
function renderAbsensi(){
    attList.innerHTML = "";
    dataAtt.forEach((a,i)=>{
        let k = dataEmp.find(x=>x.nip===a.emp);
        attList.innerHTML += `
            <tr>
                <td>${a.tgl}</td>
                <td>${k ? k.nama : a.emp}</td>
                <td>${a.sts}</td>
                <td>${a.late}</td>
                <td>${a.ot}</td>
                <td><button class="btn-danger" onclick="delAtt(${i})">X</button></td>
            </tr>
        `;
    });
}

// render laporan gaji
function renderReports(){
    repList.innerHTML = "";
    dataSlip.forEach((s,i)=>{
        repList.innerHTML += `
            <tr>
                <td>${s.month}</td>
                <td>${s.nama}</td>
                <td>${rupiah(s.gross)}</td>
                <td>${rupiah(s.ded)}</td>
                <td><b>${rupiah(s.take)}</b></td>
            </tr>
        `;
    });
}

// select payroll
function fillPayrollSelect(){
    payEmpSelect.innerHTML = "";
    dataEmp.forEach(e=>{
        payEmpSelect.innerHTML += `<option value="${e.nip}">${e.nama} (${e.nip})</option>`;
    });
}

// select slip list
function fillSlipSelect(){
  slipSelect.innerHTML = "";
  if(dataSlip.length===0){
    slipSelect.innerHTML = `<option value="">Belum ada slip</option>`;
    slipViewCard.style.display="none";
    return;
  }
  dataSlip.forEach((s,i)=>{
    slipSelect.innerHTML += `<option value="${i}">${s.month} - ${s.nama} (${s.nip})</option>`;
  });
}

// ===============================
// KARYAWAN CRUD
// ===============================
let editEmpIdx = null;

function openEmpModal(i=null){
    empModal.style.display="flex";
    editEmpIdx = i;

    if(i===null){
        empModalTitle.textContent="Tambah Karyawan";
        empNip.value=""; empName.value="";
        empDept.value=""; empPos.value="";
        empGrade.value = dataGrade[0].name;
    }else{
        let e = dataEmp[i];
        empModalTitle.textContent="Edit Karyawan";
        empNip.value=e.nip;
        empName.value=e.nama;
        empDept.value=e.dept;
        empPos.value=e.pos;
        empGrade.value=e.grade;
    }
}
function closeEmpModal(){ empModal.style.display="none"; }

function saveEmp(){
    let obj = {
        nip:empNip.value.trim(),
        nama:empName.value.trim(),
        dept:empDept.value.trim(),
        pos:empPos.value.trim(),
        grade:empGrade.value
    };
    if(!obj.nip || !obj.nama) return alert("Lengkapi data!");

    // cek nip double
    let doubleNip = dataEmp.find((x,idx)=>x.nip===obj.nip && idx!==editEmpIdx);
    if(doubleNip) return alert("NIP sudah ada!");

    if(editEmpIdx===null) dataEmp.push(obj);
    else dataEmp[editEmpIdx]=obj;

    saveAll(); closeEmpModal(); renderAll();
}
function editEmp(i){ openEmpModal(i); }
function delEmp(i){
    if(!confirm("Hapus karyawan?")) return;
    dataEmp.splice(i,1);
    saveAll(); renderAll();
}

// ===============================
// JABATAN/GRADE CRUD
// ===============================
let editGradeIdx = null;

function openGradeModal(i=null){
    gradeModal.style.display="flex";
    editGradeIdx=i;

    if(i===null){
        gradeModalTitle.textContent="Tambah Jabatan";
        grName.value=""; grBasic.value="";
        grPosAllow.value=""; grOt.value="";
    }else{
        let g=dataGrade[i];
        gradeModalTitle.textContent="Edit Jabatan";
        grName.value=g.name;
        grBasic.value=g.basic;
        grPosAllow.value=g.pos;
        grOt.value=g.ot;
    }
}
function closeGradeModal(){ gradeModal.style.display="none"; }

function saveGrade(){
    let g={
        name:grName.value.trim(),
        basic:Number(grBasic.value||0),
        pos:Number(grPosAllow.value||0),
        ot:Number(grOt.value||0)
    };
    if(!g.name) return alert("Nama jabatan wajib!");

    let double = dataGrade.find((x,idx)=>x.name===g.name && idx!==editGradeIdx);
    if(double) return alert("Jabatan sudah ada!");

    if(editGradeIdx===null) dataGrade.push(g);
    else dataGrade[editGradeIdx]=g;

    saveAll(); closeGradeModal(); renderAll();
}
function editGrade(i){ openGradeModal(i); }
function delGrade(i){
    if(!confirm("Hapus jabatan?")) return;
    dataGrade.splice(i,1);
    saveAll(); renderAll();
}

// ===============================
// ABSENSI CRUD
// ===============================
function openAttModal(){
    attModal.style.display="flex";
    attDate.valueAsDate = new Date();

    attEmp.innerHTML="";
    dataEmp.forEach(e=>{
        attEmp.innerHTML += `<option value="${e.nip}">${e.nama}</option>`;
    });
}
function closeAttModal(){ attModal.style.display="none"; }

function saveAtt(){
    let obj={
        tgl:attDate.value,
        emp:attEmp.value,
        sts:attStatus.value,
        late:Number(attLate.value||0),
        ot:Number(attOt.value||0)
    };
    if(!obj.tgl || !obj.emp) return alert("Tanggal/karyawan belum diisi");
    dataAtt.push(obj);
    saveAll(); closeAttModal(); renderAll();
}
function delAtt(i){
    if(!confirm("Hapus absensi?")) return;
    dataAtt.splice(i,1);
    saveAll(); renderAll();
}

// ===============================
// PENGGAJIAN + SLIP
// ===============================
let slipNow=null;

function runPayroll(){
    let nip = payEmpSelect.value;
    let bln = payMonth.value;
    if(!nip || !bln) return alert("Pilih karyawan dan bulan dulu");

    let emp = dataEmp.find(e=>e.nip===nip);
    if(!emp) return alert("Karyawan tidak ketemu");

    let gr = dataGrade.find(g=>g.name===emp.grade);
    if(!gr) return alert("Jabatan karyawan belum valid");

    // filter absensi per bulan
    let att = dataAtt.filter(a=>a.emp===nip && a.tgl.startsWith(bln));

    let telat = att.reduce((s,a)=>s + (a.late||0),0);
    let otjam = att.reduce((s,a)=>s + (a.ot||0),0);
    let alpa = att.filter(a=>a.sts==="alpa").length;

    // tunjangan input
    let trans = Number(payTransport.value||0);
    let meal  = Number(payMeal.value||0);
    let hadir = Number(payAtt.value||0);
    let otherA= Number(payOtherAllow.value||0);
    let otherD= Number(payOtherDed.value||0);

    // core gaji
    let basic = gr.basic;
    let tunjJabatan = gr.pos;
    let lemburPay = otjam * gr.ot;

    let gross = basic + tunjJabatan + trans + meal + hadir + otherA + lemburPay;

    // potongan enterprise simpel
    let bpjsTk = basic * 0.02;
    let bpjsKes= basic * 0.01;
    let telatD = telat * 1000;
    let alpaD  = alpa * 150000;
    let pph = (gross > 5000000) ? (gross * 0.05) : 0;

    let totalDed = bpjsTk + bpjsKes + telatD + alpaD + pph + otherD;
    let thp = gross - totalDed;

    slipNow={
        month:bln,
        nip:emp.nip,
        nama:emp.nama,
        dept:emp.dept,
        pos:emp.pos,
        grade:emp.grade,
        basic,
        tunjJabatan,
        trans, meal, hadir, otherA, lemburPay,
        otjam, telat, alpa,
        bpjsTk, bpjsKes, pph, telatD, alpaD, otherD,
        gross,
        ded:totalDed,
        take:thp
    };

    renderSlipPreview();
    payPreviewCard.style.display="block";
}

function renderSlipPreview(){
    slipBox.innerHTML = `
        <h2>Slip Gaji</h2>
        <div class="row"><b>Nama</b><span>${slipNow.nama}</span></div>
        <div class="row"><b>NIP</b><span>${slipNow.nip}</span></div>
        <div class="row"><b>Dept/Posisi</b><span>${slipNow.dept} / ${slipNow.pos}</span></div>
        <div class="row"><b>Jabatan</b><span>${slipNow.grade}</span></div>
        <div class="row"><b>Bulan</b><span>${slipNow.month}</span></div>
        <hr>
        <h3>Pendapatan</h3>
        <div class="row"><span>Gaji Pokok</span><b>${rupiah(slipNow.basic)}</b></div>
        <div class="row"><span>Tunj. Jabatan</span><b>${rupiah(slipNow.tunjJabatan)}</b></div>
        <div class="row"><span>Tunj. Transport</span><b>${rupiah(slipNow.trans)}</b></div>
        <div class="row"><span>Tunj. Makan</span><b>${rupiah(slipNow.meal)}</b></div>
        <div class="row"><span>Tunj. Kehadiran</span><b>${rupiah(slipNow.hadir)}</b></div>
        <div class="row"><span>Lembur (${slipNow.otjam} jam)</span><b>${rupiah(slipNow.lemburPay)}</b></div>
        <div class="row"><span>Tunjangan Lain</span><b>${rupiah(slipNow.otherA)}</b></div>
        <hr>
        <h3>Potongan</h3>
        <div class="row"><span>BPJS TK</span><b>${rupiah(slipNow.bpjsTk)}</b></div>
        <div class="row"><span>BPJS Kes</span><b>${rupiah(slipNow.bpjsKes)}</b></div>
        <div class="row"><span>PPh21</span><b>${rupiah(slipNow.pph)}</b></div>
        <div class="row"><span>Telat (${slipNow.telat} menit)</span><b>${rupiah(slipNow.telatD)}</b></div>
        <div class="row"><span>Alpa (${slipNow.alpa} hari)</span><b>${rupiah(slipNow.alpaD)}</b></div>
        <div class="row"><span>Potongan Lain</span><b>${rupiah(slipNow.otherD)}</b></div>
        <hr>
        <div class="row"><b>Gross</b><b>${rupiah(slipNow.gross)}</b></div>
        <div class="row"><b>Total Potongan</b><b>${rupiah(slipNow.ded)}</b></div>
        <div class="row" style="font-size:18px;"><b>Take Home Pay</b><b>${rupiah(slipNow.take)}</b></div>
    `;
}

// simpan slip ke list
function saveSlip(){
  if(!slipNow) return alert("Belum ada slip dihitung");
  let exist = dataSlip.find(s=>s.month===slipNow.month && s.nip===slipNow.nip);
  if(exist){
    if(!confirm("Slip bulan ini sudah ada, mau overwrite?")) return;
    Object.assign(exist, slipNow);
  }else{
    dataSlip.push(slipNow);
  }
  saveAll();
  fillSlipSelect();
  renderReports();
  alert("Slip tersimpan âœ…");
}

// export pdf (pakai box yang lagi tampil)
function exportSlip(){
  let target = slipViewCard.style.display==="none" ? slipBox : slipViewBox;
  html2pdf().from(target).set({
      filename:"SlipGaji.pdf",
      html2canvas:{scale:2}
  }).save();
}

// view slip dari menu slip gaji
function viewSlipFromList(){
  let idx = slipSelect.value;
  if(idx==="" || dataSlip.length===0) return;

  let s = dataSlip[Number(idx)];
  slipViewBox.innerHTML = slipBox.innerHTML = ""; // reset

  // reuse preview renderer
  slipNow = s;
  renderSlipPreview();

  // copy preview to view
  slipViewBox.innerHTML = slipBox.innerHTML;
  slipViewCard.style.display="block";
}

// init
renderAll();
</script>

</body>
</html>
